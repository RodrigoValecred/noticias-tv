<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Previsão do Tempo</title>
    <!-- 1. SCRIPT DO CHART.JS (PRINCIPAL) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- 2. SCRIPT DO PLUGIN DATALABELS (RÓTULOS) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.1.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <!-- 3. SCRIPT DO PLUGIN ANNOTATION (ANOTAÇÕES/FAIXAS) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: #111;
            color: #f0f0f0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            box-sizing: border-box;
        }
        .weather-container {
            background-color: #222;
            padding: 15px;
            border-radius: 8px;
            width: 95%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 0 15px rgba(0,0,0,0.6);
        }
        h1#location-name {
            text-align: center;
            color: #ffffff;
            font-size: 2.0em;
            margin-top: 0;
            margin-bottom: 5px;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 50vh;
        }
        #forecast-text {
            text-align: center;
            margin-top: 5px;
            width: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 5px 0;
        }
        #forecast-text img {
            width: 40px;
            height: 40px;
        }
    </style>
</head>
<body>
    <div class="weather-container">
        <h1 id="location-name">Previsão do Tempo</h1>
        <div class="chart-container">
            <canvas id="weatherChart"></canvas>
        </div>
        <div id="forecast-text"></div>
    </div>

    <script>
        // --- CONFIGURAÇÕES ---
        const API_KEY = '90f67f01d5b8618ca6fa64716d5240ed';
        const CITY_NAME = 'Tatui,BR';
        const PROXY_URL = 'https://corsproxy.io/?';
        const REFRESH_INTERVAL_HOURS = 3;
        // --- FIM ---

        const forecastTextElement = document.getElementById('forecast-text');
        const locationNameElement = document.getElementById('location-name');
        let weatherChart = null;

        // REMOVIDO: Bloco de registro manual dos plugins.
        // As versões mais novas dos plugins (carregadas acima) se registram automaticamente.
        // Apenas precisamos ativá-los e configurá-los nas opções do gráfico.
        console.log("Chart.js e plugins carregados.");

        function getApiUrl() {
            return `https://api.openweathermap.org/data/2.5/forecast?q=${CITY_NAME}&appid=${API_KEY}&units=metric&lang=pt_br`;
        }

        async function fetchWeatherData() {
            locationNameElement.textContent = `Previsão do Tempo para ${CITY_NAME.split(',')[0]}`;
            const apiUrl = getApiUrl();
            const urlToFetch = PROXY_URL + apiUrl;

            console.log("Buscando dados de:", urlToFetch);
            try {
                const response = await fetch(urlToFetch);
                if (!response.ok) {
                    throw new Error(`Erro de rede: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                console.log("Dados recebidos:", data);

                if (data.cod && data.cod !== "200") {
                    throw new Error(`Erro da API: ${data.message || 'Erro desconhecido'}`);
                }
                processAndDisplayData(data);
            } catch (error) {
                console.error("Falha ao buscar dados do tempo:", error);
                forecastTextElement.innerHTML = `<p style="color:red;">Erro ao carregar previsão: ${error.message}</p>`;
            }
        }

        function processAndDisplayData(data) {
            if (!data || !data.list || data.list.length === 0) {
                forecastTextElement.innerHTML = "<p>Dados de previsão não disponíveis.</p>";
                return;
            }
            const dailyData = {};
            data.list.forEach(item => {
                const date = item.dt_txt.split(' ')[0];
                if (!dailyData[date]) {
                    dailyData[date] = { temps: [], weather_descriptions: [], icons: [] };
                }
                dailyData[date].temps.push(item.main.temp);
                dailyData[date].weather_descriptions.push(item.weather[0].description);
                dailyData[date].icons.push(item.weather[0].icon);
            });
            const labels = [];
            const minTemps = [];
            const maxTemps = [];
            let textForecastHTML = "";
            const forecastDays = Object.keys(dailyData).sort().slice(0, 5);
            forecastDays.forEach(date => {
                const dayInfo = dailyData[date];
                labels.push(date.substring(8, 10) + '/' + date.substring(5, 7));
                minTemps.push(Math.min(...dayInfo.temps));
                maxTemps.push(Math.max(...dayInfo.temps));
                const midDayIndex = Math.floor(dayInfo.icons.length / 2);
                const icon = dayInfo.icons[midDayIndex];
                textForecastHTML += `<img src="https://openweathermap.org/img/wn/${icon}@2x.png" alt="" title="${dayInfo.weather_descriptions[midDayIndex]}">`;
            });
            forecastTextElement.innerHTML = textForecastHTML;
            renderWeatherChart(labels, minTemps, maxTemps);
        }

        function renderWeatherChart(labels, minData, maxData) {
            const ctx = document.getElementById('weatherChart').getContext('2d');
            if (weatherChart) {
                weatherChart.destroy();
            }
            weatherChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Temp. Mínima (°C)',
                        data: minData,
                        borderColor: 'blue',
                        backgroundColor: 'rgba(0, 0, 255, 0.1)',
                        tension: 0.1
                    }, {
                        label: 'Temp. Máxima (°C)',
                        data: maxData,
                        borderColor: 'red',
                        backgroundColor: 'rgba(255, 0, 0, 0.1)',
                        tension: 0.1
                    }]
                },
                // IMPORTANTE: Os plugins agora precisam ser registrados aqui para o Chart.js v3+
                plugins: [ChartDataLabels],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) { return value.toFixed(0) + '°C'; }
                            }
                        }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Próximos 5 Dias' },
                        tooltip: { enabled: false },
                        // Configuração do plugin DATALABELS
                        datalabels: {
                            align: (context) => context.datasetIndex === 0 ? 'bottom' : 'top',
                            anchor: 'end',
                            backgroundColor: (context) => context.dataset.borderColor,
                            borderRadius: 4,
                            color: 'white',
                            font: { weight: 'bold', size: 10 },
                            formatter: (value) => value.toFixed(0) + '°',
                            padding: 4
                        },
                        // Configuração do plugin ANNOTATION
                        annotation: {
                            drawTime: 'beforeDatasetsDraw',
                            annotations: {
                                blueZone: { type: 'box', yMin: 0, yMax: 10, backgroundColor: 'rgba(0, 0, 255, 0.1)', borderColor: 'transparent' },
                                whiteZone: { type: 'box', yMin: 10, yMax: 20, backgroundColor: 'rgba(220, 220, 220, 0.1)', borderColor: 'transparent' },
                                yellowZone: { type: 'box', yMin: 20, yMax: 30, backgroundColor: 'rgba(255, 255, 0, 0.1)', borderColor: 'transparent' },
                                redZone: { type: 'box', yMin: 30, yMax: 45, backgroundColor: 'rgba(255, 0, 0, 0.1)', borderColor: 'transparent' }
                            }
                        }
                    }
                }
            });
        }

        fetchWeatherData();
        setInterval(fetchWeatherData, REFRESH_INTERVAL_HOURS * 60 * 60 * 1000);
    </script>
</body>
</html>
