<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Previsão do Tempo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- O nome global deste plugin é "ChartAnnotation" -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: #111;
            color: #f0f0f0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            box-sizing: border-box;
        }

        .weather-container {
            background-color: #222;
            padding: 15px;
            border-radius: 8px;
            width: 95%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 0 15px rgba(0,0,0,0.6);
        }

        h1#location-name {
            text-align: center;
            color: #ffffff;
            font-size: 2.0em;
            margin-top: 0;
            margin-bottom: 5px;
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 50vh;
        }

        #forecast-text {
            text-align: center;
            margin-top: 5px;
            width: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 5px 0;
        }

        #forecast-text img {
            width: 40px;
            height: 40px;
        }
    </style>
</head>
<body>
    <div class="weather-container">
        <h1 id="location-name">Previsão do Tempo</h1>
        <div class="chart-container">
            <canvas id="weatherChart"></canvas>
        </div>
        <div id="forecast-text">
            <!-- Previsão textual -->
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÕES ---
        const API_KEY = '90f67f01d5b8618ca6fa64716d5240ed';
        const CITY_NAME = 'Tatui,BR';
        // --- CORREÇÃO 2: Alteração do PROXY ---
        const PROXY_URL = 'https://corsproxy.io/?'; // Usando um proxy CORS mais confiável
        const REFRESH_INTERVAL_HOURS = 3;
        // --- FIM ---

        const forecastTextElement = document.getElementById('forecast-text');
        const locationNameElement = document.getElementById('location-name');
        let weatherChart = null;

        // --- CORREÇÃO 1: Nome correto do plugin de anotação ---
        try {
            // O nome global correto para o plugin de anotação é 'ChartAnnotation'
            Chart.register(ChartDataLabels, ChartAnnotation);
            console.log("Plugins DataLabels e Annotation registrados com sucesso.");
        } catch (e) {
            console.error("Erro ao registrar plugins:", e);
            try {
                Chart.register(ChartDataLabels);
                console.warn("Plugin Annotation não registrado, mas DataLabels sim.");
            } catch (e2) {
                console.error("Erro ao registrar DataLabels:", e2);
            }
        }

        function getApiUrl() {
            return `https://api.openweathermap.org/data/2.5/forecast?q=${CITY_NAME}&appid=${API_KEY}&units=metric&lang=pt_br`;
        }

        async function fetchWeatherData() {
            locationNameElement.textContent = `Previsão do Tempo para ${CITY_NAME.split(',')[0]}`;
            const apiUrl = getApiUrl();
            // --- CORREÇÃO 2: Simplificação da montagem da URL ---
            const urlToFetch = PROXY_URL + apiUrl; // O novo proxy não precisa de encodeURIComponent

            console.log("Buscando dados de:", urlToFetch);
            try {
                const response = await fetch(urlToFetch);
                if (!response.ok) {
                    throw new Error(`Erro de rede: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                console.log("Dados recebidos:", data);

                if (data.cod && data.cod !== "200") {
                    throw new Error(`Erro da API: ${data.message || 'Erro desconhecido'}`);
                }

                processAndDisplayData(data);
            } catch (error) {
                console.error("Falha ao buscar dados do tempo:", error);
                forecastTextElement.innerHTML = `<p style="color:red;">Erro ao carregar previsão: ${error.message}</p>`;
            }
        }

        function processAndDisplayData(data) {
            if (!data || !data.list || data.list.length === 0) {
                forecastTextElement.innerHTML = "<p>Dados de previsão não disponíveis.</p>";
                return;
            }

            const dailyData = {};
            data.list.forEach(item => {
                const date = item.dt_txt.split(' ')[0];
                if (!dailyData[date]) {
                    dailyData[date] = {
                        temps: [],
                        weather_descriptions: [],
                        icons: [],
                        humidity: [],
                        wind_speed: []
                    };
                }
                dailyData[date].temps.push(item.main.temp);
                dailyData[date].weather_descriptions.push(item.weather[0].description);
                dailyData[date].icons.push(item.weather[0].icon);
                dailyData[date].humidity.push(item.main.humidity);
                dailyData[date].wind_speed.push(item.wind.speed);
            });

            const labels = [];
            const minTemps = [];
            const maxTemps = [];
            let textForecastHTML = "";
            const forecastDays = Object.keys(dailyData).sort().slice(0, 5);

            forecastDays.forEach(date => {
                const dayInfo = dailyData[date];
                const dayMinTemp = Math.min(...dayInfo.temps);
                const dayMaxTemp = Math.max(...dayInfo.temps);
                const dateParts = date.split('-');
                const displayDate = `${dateParts[2]}/${dateParts[1]}`;
                labels.push(displayDate);
                minTemps.push(dayMinTemp.toFixed(1));
                maxTemps.push(dayMaxTemp.toFixed(1));
                const midDayIndex = Math.floor(dayInfo.weather_descriptions.length / 2);
                const icon = dayInfo.icons[midDayIndex];
                textForecastHTML += `<img src="https://openweathermap.org/img/wn/${icon}@2x.png" alt="" title="${dayInfo.weather_descriptions[midDayIndex]}">`;
            });

            forecastTextElement.innerHTML = textForecastHTML;
            renderWeatherChart(labels, minTemps, maxTemps);
        }

        function renderWeatherChart(labels, minData, maxData) {
            const ctx = document.getElementById('weatherChart').getContext('2d');
            if (weatherChart) {
                weatherChart.destroy();
            }
            weatherChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Temp. Mínima (°C)',
                        data: minData,
                        borderColor: 'blue',
                        backgroundColor: 'rgba(0, 0, 255, 0.1)',
                        fill: false,
                        tension: 0.1
                    }, {
                        label: 'Temp. Máxima (°C)',
                        data: maxData,
                        borderColor: 'red',
                        backgroundColor: 'rgba(255, 0, 0, 0.1)',
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#ccc', font: { size: 10 } }
                        },
                        y: {
                            grid: { color: 'rgba(204, 204, 204, 0.15)' },
                            beginAtZero: false,
                            ticks: {
                                color: '#ccc',
                                stepSize: 5,
                                font: { size: 10 },
                                callback: function(value) {
                                    return value + '°C';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { color: '#ddd', font: { size: 12 }, boxWidth: 20, padding: 10 }
                        },
                        title: {
                            display: true,
                            text: 'Próximos 5 Dias',
                            color: '#eee',
                            font: { size: 16 },
                            padding: { bottom: 10 }
                        },
                        tooltip: { enabled: false },
                        datalabels: {
                            align: function(context) {
                                return context.datasetIndex === 0 ? 'bottom' : 'top';
                            },
                            anchor: function(context) {
                                return context.datasetIndex === 0 ? 'end' : 'start';
                            },
                            backgroundColor: function(context) {
                                return context.dataset.borderColor;
                            },
                            borderRadius: 4,
                            color: 'white',
                            font: { weight: 'bold', size: 10 },
                            formatter: function(value, context) {
                                return parseFloat(value).toFixed(0) + '°';
                            },
                            padding: 4
                        },
                        annotation: {
                            drawTime: 'beforeDatasetsDraw',
                            annotations: {
                                blueZone: { type: 'box', yMin: 0, yMax: 10, backgroundColor: 'rgba(0, 0, 255, 0.15)', borderColor: 'transparent' },
                                whiteZone: { type: 'box', yMin: 10, yMax: 20, backgroundColor: 'rgba(220, 220, 220, 0.15)', borderColor: 'transparent' },
                                yellowZone: { type: 'box', yMin: 20, yMax: 30, backgroundColor: 'rgba(255, 255, 0, 0.15)', borderColor: 'transparent' },
                                redZone: { type: 'box', yMin: 30, yMax: 45, backgroundColor: 'rgba(255, 0, 0, 0.15)', borderColor: 'transparent' }
                            }
                        }
                    },
                    elements: {
                        point: { radius: 2, hoverRadius: 4 },
                        line: { borderWidth: 2, tension: 0.1 }
                    }
                }
            });
        }

        // Carregar dados ao iniciar e definir intervalo
        fetchWeatherData();
        setInterval(fetchWeatherData, REFRESH_INTERVAL_HOURS * 60 * 60 * 1000);
    </script>
</body>
</html>
