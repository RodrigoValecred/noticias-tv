<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notícias do Brasil</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #111;
            color: #f0f0f0;
            overflow: hidden;
            height: 100vh;
        }
        .container {
            max-width: 95%;
            margin: auto;
        }
        h1 {
            text-align: center;
            color: #2BB34E;
            font-size: 2.5em;
            margin-bottom: 20px;
        }
        .news-item {
            background-color: #222;
            border: 1px solid #444;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
        }
        .news-item h3 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1.2em;
            color: #e0e0e0;
        }
        .news-item p {
            font-size: 1.2em;
            line-height: 1.6;
            margin-bottom: 8px;
            color: #cccccc;
        }
        .news-item small {
            font-size: 0.9em;
            color: #888;
        }
        .news-item a {
            color: inherit;
            text-decoration: none;
            pointer-events: none;
        }
        #loader {
            text-align: center;
            font-size: 1.5em;
            padding: 30px;
        }
    </style>
    <!-- CORREÇÃO 1: Carregando a versão mais recente do RSS Parser via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/rss-parser/dist/rss-parser.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Últimas Notícias</h1>
        <div id="news-feed">
            <div id="loader">Carregando notícias...</div>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÕES ---
        const DEFAULT_RSS_URL = 'https://news.google.com/rss?hl=pt-BR&gl=BR&ceid=BR:pt-BR';
        const DEFAULT_SOURCE_NAME = 'Google Notícias';
        const MAX_ITEMS = 5;
        const REFRESH_INTERVAL_MINUTES = 60;
        const MAX_RETRIES = 3;
        const RETRY_DELAY_MS = 3000; // Reduzido para 3 segundos

        // --- CORREÇÃO 2: Usando um proxy CORS mais confiável e estável ---
        const PROXY_URL = 'https://corsproxy.io/?'; 
        // --- FIM DAS CONFIGURAÇÕES ---
        
        const newsFeedElement = document.getElementById('news-feed');
        const loaderElement = document.getElementById('loader');
        // A biblioteca carregada via CDN cria a variável global "RSSParser"
        let parser = new RSSParser();
        let currentRetry = 0;
        
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // Determina o feed e o nome da fonte a partir dos parâmetros da URL ou usa os padrões
        const RSS_URL = decodeURIComponent(getQueryParam('feedUrl') || DEFAULT_RSS_URL);
        const SOURCE_NAME = decodeURIComponent(getQueryParam('sourceName') || '');

        async function fetchNews() {
            if (currentRetry === 0) {
                loaderElement.style.display = 'block';
                // Não limpa as notícias antigas para não ter uma tela em branco piscando durante a atualização
            }
            console.log(`Buscando notícias de ${RSS_URL} (Tentativa ${currentRetry + 1}/${MAX_RETRIES})`);

            // --- CORREÇÃO 3: Construção de URL correta para o novo proxy ---
            // O novo proxy não precisa de 'encodeURIComponent'.
            const urlToFetch = PROXY_URL + RSS_URL;
            console.log("URL de busca:", urlToFetch);

            try {
                const feed = await parser.parseURL(urlToFetch);
                loaderElement.style.display = 'none';
                currentRetry = 0; // Sucesso, reseta o contador
                console.log("Feed recebido com sucesso:", feed);
                displayNews(feed);

            } catch (err) {
                console.error(`Erro na tentativa ${currentRetry + 1}:`, err);
                currentRetry++;
                
                if (currentRetry < MAX_RETRIES) {
                    newsFeedElement.innerHTML = `<p style='color:orange;'>Falha ao buscar notícias. Tentando novamente em ${RETRY_DELAY_MS / 1000}s... (${currentRetry}/${MAX_RETRIES})</p>`;
                    setTimeout(fetchNews, RETRY_DELAY_MS);
                } else {
                    loaderElement.style.display = 'none';
                    newsFeedElement.innerHTML = `<p style='color:red;'>Não foi possível carregar as notícias. Verifique o link do feed RSS e a conexão.</p>`;
                    console.error("Falha definitiva ao buscar RSS após", MAX_RETRIES, "tentativas.");
                }
            }
        }

        function displayNews(feed) {
            if (!feed || !feed.items || feed.items.length === 0) {
                newsFeedElement.innerHTML = "<p style='color:orange;'>Nenhuma notícia encontrada no feed.</p>";
                return;
            }

            // Determina o nome da fonte para o título da página
            const displaySourceName = SOURCE_NAME || feed.title || DEFAULT_SOURCE_NAME;
            document.querySelector('h1').textContent = displaySourceName;

            let newsHTML = '';
            feed.items.slice(0, MAX_ITEMS).forEach(item => {
                const title = item.title || 'Sem título';
                
                // Limpa o snippet de tags HTML
                let snippet = item.contentSnippet || item.description || '';
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = snippet;
                snippet = (tempDiv.textContent || tempDiv.innerText || "").substring(0, 200);

                newsHTML += `
                    <div class="news-item">
                        <h3>${title}</h3>
                        ${snippet ? `<p>${snippet}...</p>` : ''}
                    </div>
                `;
            }); 
        
            newsFeedElement.innerHTML = newsHTML;
            console.log("Notícias carregadas e HTML atualizado.");
        }

        // Carrega as notícias ao iniciar
        fetchNews();

        // Atualiza as notícias periodicamente
        if (REFRESH_INTERVAL_MINUTES > 0) {
            setInterval(() => {
                currentRetry = 0;
                fetchNews();
            }, REFRESH_INTERVAL_MINUTES * 60 * 1000);
        }
    </script>
</body>
</html>
